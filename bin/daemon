#!/usr/bin/env node
'use strict';

var sensor = require('../sensor');
var config = require('../config');
var reporter = require('../reporter');
var server = require('../server').createServer();
var agent = require('../agent');

/*
 * Initialize menagerie agent.
 */
agent.init(config.agent, config);

reporter.init(config.reporter);


console.log('config');
console.log(JSON.stringify(config, null, 4));

//Server: We should be able to change configuration on
//GUI/Client and then reboot app.
server.start().on('server.ready', function(){
    /*
     * Sensor uses app to publish events.
     */
    sensor.init(server, config.sensor);
});

server.on('sensor.event', function(event){
    console.warn('sensor.event', event);

    //We could just pass through the event?
    var payload = getPayload({
            event: event.type,
            value: event.value,
            time: event.time || Date.now()
        }, {
            id: event.id
        }, config.reporter.tags);

    reporter.buffer(payload);
});


var extend = require('gextend');
function getPayload(values, tags, defaults){
    var out = extend({}, defaults, tags);
    return [values, out];
}
